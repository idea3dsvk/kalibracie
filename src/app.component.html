<!-- Login Screen -->
@if (!authService.isLoggedIn()) {
  <div class="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900 px-4">
    <div class="max-w-md w-full bg-white dark:bg-slate-800 shadow-xl rounded-2xl p-8 space-y-8">
      <div class="text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V4m0 16v-2M8 8l1.414-1.414M14.586 14.586L16 16m-1.414-8.414L16 6m-8.414 9.414L6 16" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 14a2 2 0 100-4 2 2 0 000 4z" />
          </svg>
          <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">{{ 'login.title' | translate }}</h1>
        </div>
        <p class="text-slate-600 dark:text-slate-400">{{ 'login.subtitle' | translate }}</p>
      </div>
      <form class="space-y-6" [formGroup]="loginForm" (ngSubmit)="handleLogin()">
        <div>
          <label for="username" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'login.username' | translate }}</label>
          <input id="username" type="text" formControlName="username" required class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200" [placeholder]="'login.usernamePlaceholder' | translate">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'login.password' | translate }}</label>
          <input id="password" type="password" formControlName="password" required class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200" [placeholder]="'login.passwordPlaceholder' | translate">
        </div>
        @if (loginError()) {
          <div class="p-3 bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 text-sm rounded-lg">
            {{ loginError() }}
          </div>
        }
        <div>
          <button type="submit" [disabled]="loginForm.invalid" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed">
            {{ 'login.loginButton' | translate }}
          </button>
        </div>
         <div class="text-xs text-slate-500 dark:text-slate-400 text-center pt-4">
           <p>{{ 'login.demoAccounts' | translate }}:</p>
           <p><strong>Admin:</strong> admin / password</p>
           <p><strong>Moderator:</strong> moderator / password</p>
           <p><strong>User:</strong> user / password</p>
         </div>
      </form>
    </div>
  </div>
} @else {
  <div class="container mx-auto p-4 md:p-8">
    
    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
      <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V4m0 16v-2M8 8l1.414-1.414M14.586 14.586L16 16m-1.414-8.414L16 6m-8.414 9.414L6 16" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 14a2 2 0 100-4 2 2 0 000 4z" />
          </svg>
        <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">{{ 'header.title' | translate }}</h1>
      </div>
      <div class="flex items-center gap-2">
        <!-- User Info & Logout -->
        @if(authService.currentUser(); as user) {
          <div class="text-sm text-right">
            <p class="font-semibold text-slate-800 dark:text-slate-200">{{ user.username }}</p>
            <p class="text-slate-500 dark:text-slate-400">{{ user.role }}</p>
          </div>
          <button (click)="handleLogout()" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition" [title]="'header.logout' | translate">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
          </button>
        }

        <div class="h-8 border-l border-slate-200 dark:border-slate-700 mx-2"></div>
        
        <!-- Language Switcher -->
        <div class="relative">
          <button (click)="showLangDropdown.set(!showLangDropdown())" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h-3.242c-.517 0-.974-.358-1.152-.845l-2.433-4.316a11.948 11.948 0 01.12-1.405l1.92-3.412a1.125 1.125 0 01.961-.694h3.242c.517 0 .974.358 1.152.845l2.433 4.316a11.948 11.948 0 01-.12 1.405l-1.92 3.412a1.125 1.125 0 01-.961.694zM18 9h1.25c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125H18v-3.75z" />
            </svg>
          </button>
          @if(showLangDropdown()) {
            <div class="absolute right-0 mt-2 w-40 bg-white dark:bg-slate-700 rounded-md shadow-lg z-20" (clickout)="showLangDropdown.set(false)">
              @for(lang of supportedLanguages; track lang.code) {
                <a href="#" (click)="switchLanguage(lang.code); $event.preventDefault()" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-600">
                  <span>{{ lang.flag }}</span>
                  <span>{{ lang.name }}</span>
                </a>
              }
            </div>
          }
        </div>

         <!-- Dark Mode Toggle -->
        <button (click)="toggleDarkMode()" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
          @if(isDarkMode()) {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
          }
        </button>
        @if(displayedDevices().length > 0) {
          <div class="flex items-center gap-2 border-l border-slate-200 dark:border-slate-700 pl-2 ml-2">
            <button (click)="exportToCSV()" class="flex items-center gap-2 bg-slate-500 text-white px-3 py-2 rounded-lg hover:bg-slate-600 transition shadow-md text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
              CSV
            </button>
            <button (click)="exportToPDF()" class="flex items-center gap-2 bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition shadow-md text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
              PDF
            </button>
          </div>
        }
        @if(canAddDevice()) {
          <button (click)="openAddModal()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow-md whitespace-nowrap">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            {{ 'header.addDevice' | translate }}
          </button>
        }
      </div>
    </header>

    <!-- Dashboard -->
    <section class="mb-8 p-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700">
      <h2 class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">{{ 'dashboard.title' | translate }}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Stats Cards -->
        <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
          <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">{{ 'dashboard.overdue' | translate }}</h3>
          <p class="text-3xl font-bold text-red-600 dark:text-red-500">{{ overdueCount() }}</p>
        </div>
        <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
          <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">{{ 'dashboard.dueSoonThisMonth' | translate }}</h3>
          <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-500">{{ dueSoonThisMonthCount() }}</p>
        </div>
        <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg col-span-1 md:col-span-2">
          <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">{{ 'dashboard.deviceStatus' | translate }} ({{ devices().length }})</h3>
          <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-6 flex overflow-hidden">
              @for(item of chartData(); track item.status) {
                <div [style.width.%]="item.percentage" [class]="item.classes" class="h-full flex items-center justify-center text-white text-xs font-bold" [title]="item.label + ': ' + item.count"></div>
              }
          </div>
          <div class="flex justify-around mt-2 text-xs text-slate-600 dark:text-slate-400">
            @for(item of chartData(); track item.status) {
              @if(item.count > 0) {
                <span class="flex items-center gap-1.5">
                  <span class="w-2 h-2 rounded-full" [class]="item.classes"></span>
                  {{ item.label }}: {{ item.count }}
                </span>
              }
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Controls -->
    <div class="mb-6 flex flex-col md:flex-row gap-4 items-center">
      <div class="relative w-full md:flex-grow">
        <input 
          type="text" 
          [placeholder]="'controls.searchPlaceholder' | translate" 
          [value]="searchTerm()"
          (input)="onSearch($event)"
          class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      </div>
      <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
        <select (change)="onManufacturerChange($event)" class="w-full sm:w-auto px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200">
          @for (manufacturer of uniqueManufacturers(); track manufacturer) {
            <option [value]="manufacturer === ('controls.allManufacturers' | translate) ? 'all' : manufacturer">{{ manufacturer }}</option>
          }
        </select>
        <select (change)="onUsageChange($event)" class="w-full sm:w-auto px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200">
          @for (usage of uniqueUsages(); track usage) {
            <option [value]="usage === ('controls.allUsages' | translate) ? 'all' : usage">{{ usage }}</option>
          }
        </select>
        <div class="flex items-center gap-2 w-full sm:w-auto px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200">
          <span class="text-sm">{{ 'controls.sortBy.label' | translate }}:</span>
          <button (click)="setSort('name')" class="font-semibold" [class.text-blue-600]="sortConfig().key === 'name'">{{ 'controls.sortBy.name' | translate }}</button>
          <button (click)="setSort('status')" class="font-semibold" [class.text-blue-600]="sortConfig().key === 'status'">{{ 'controls.sortBy.status' | translate }}</button>
          <button (click)="setSort('nextCalibrationDate')" class="font-semibold" [class.text-blue-600]="sortConfig().key === 'nextCalibrationDate'">{{ 'controls.sortBy.validity' | translate }}</button>
          <button (click)="setSort(sortConfig().key)" class="ml-auto text-slate-500">
            @if(sortConfig().direction === 'asc') {
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            }
          </button>
        </div>
      </div>
    </div>

    <!-- Device Grid -->
    @if (loading()) {
      <div class="text-center py-16 px-8 bg-white dark:bg-slate-800 rounded-lg shadow-md">
        <svg class="animate-spin h-12 w-12 mx-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <h3 class="mt-4 text-lg font-medium text-slate-800 dark:text-slate-200">{{ 'general.loading' | translate }}</h3>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">{{ 'general.loadingDevices' | translate }}</p>
      </div>
    } @else if (displayedDevices().length > 0) {
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        @for (device of displayedDevices(); track device.id) {
          @let latestCal = getLatestCalibration(device);
          @let status = getDeviceStatus(device);
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg flex flex-col justify-between border-t-4" [class.border-green-500]="status === 'valid'" [class.border-yellow-500]="status === 'due-soon'" [class.border-red-500]="status === 'overdue'" [class.border-slate-400]="status === 'uncalibrated'">
            <div (click)="openHistoryModal(device)" class="cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition rounded-t-lg flex-grow">
              @if (device.photoUrl) {
                <img [src]="device.photoUrl" [alt]="device.name" class="w-full h-48 object-cover rounded-t-lg">
              } @else {
                <div class="w-full h-48 bg-slate-200 dark:bg-slate-700 rounded-t-lg flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-slate-400 dark:text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </div>
              }
              <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-200">{{ device.name }}</h2>
                    <p class="text-sm text-slate-500 dark:text-slate-400">{{ device.serialNumber }}</p>
                  </div>
                  <div 
                    class="px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap"
                    [class]="getStatusClasses(status)">
                    {{ getStatusText(status) }}
                  </div>
                </div>
                
                <div class="space-y-3 text-sm text-slate-700 dark:text-slate-300">
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 dark:text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" />
                    </svg>
                    <span>{{ 'device.manufacturer' | translate }}: <strong class="text-slate-800 dark:text-slate-200">{{ device.manufacturer }}</strong></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 dark:text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                    <span>{{ 'device.model' | translate }}: <strong class="text-slate-800 dark:text-slate-200">{{ device.model }}</strong></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 dark:text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    <span>{{ 'device.usage' | translate }}: <strong class="text-slate-800 dark:text-slate-200">{{ device.usage }}</strong></span>
                  </div>
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 dark:text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5a.997.997 0 01.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                    <span>{{ 'device.msnCode' | translate }}: <strong class="font-mono text-slate-800 dark:text-slate-200">{{ device.msnCode }}</strong></span>
                  </div>
                  @if (latestCal) {
                    @if (latestCal.nextCalibrationDate) {
                      <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 dark:text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" />
                        </svg>
                        <span>{{ 'device.validUntil' | translate }}: <strong class="text-slate-800 dark:text-slate-200">{{ latestCal.nextCalibrationDate | date:'dd.MM.yyyy':'':translationService.currentLocale() }}</strong></span>
                      </div>
                    }
                    @if (latestCal.calibrationCertificateUrl) {
                      <div class="flex items-center gap-2" (click)="$event.stopPropagation()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 dark:text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                        <a [href]="latestCal.calibrationCertificateUrl" [download]="getCertificateFileName(device)" class="text-blue-600 dark:text-blue-400 hover:underline font-semibold">{{ 'device.downloadCertificate' | translate }}</a>
                      </div>
                    }
                  }
                </div>
              </div>
            </div>
            <div class="p-6 pt-0 flex justify-between items-center">
              @if(canCalibrate()) {
                <button (click)="openCalibrateModal(device)" class="flex-grow text-center px-4 py-2 bg-blue-50 dark:bg-blue-900/50 border-blue-200 dark:border-blue-800 border text-blue-700 dark:text-blue-300 rounded-md hover:bg-blue-100 dark:hover:bg-blue-900/80 transition text-sm font-semibold">
                  {{ 'device.calibrateButton' | translate }}
                </button>
              }
              @if(canDelete()) {
                <button (click)="deleteDevice(device.id); $event.stopPropagation()" [disabled]="isDeleting()" class="text-slate-400 dark:text-slate-500 hover:text-red-600 dark:hover:text-red-500 transition p-1 rounded-full ml-4 disabled:opacity-50 disabled:cursor-not-allowed">
                  @if(isDeleting()) {
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                  }
                </button>
              }
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="text-center py-16 px-8 bg-white dark:bg-slate-800 rounded-lg shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <h3 class="mt-2 text-lg font-medium text-slate-800 dark:text-slate-200">{{ 'general.noDevicesFound' | translate }}</h3>
        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">{{ 'general.noDevicesHint' | translate }}</p>
      </div>
    }

    <!-- Add Device Modal -->
    @if (showAddModal()) {
      <div class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-80 flex items-center justify-center z-50" (click)="closeAddModal()">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg" (click)="$event.stopPropagation()">
          <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-6 p-8 pb-0">{{ 'add.title' | translate }}</h3>
          <form [formGroup]="deviceForm" (ngSubmit)="addDevice()" class="max-h-[85vh] overflow-y-auto">
            <div class="p-8 space-y-4">
              <div>
                <label for="photo" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'device.photo' | translate }}</label>
                @if (selectedFileBase64()) {
                  <div class="mb-2 h-48 w-full flex items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                      <img [src]="selectedFileBase64()" alt="Náhľad" class="max-h-full max-w-full object-contain rounded-md">
                  </div>
                }
                <label for="photo" class="relative cursor-pointer bg-white dark:bg-slate-700 rounded-md font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500 border border-slate-300 dark:border-slate-600 p-2 text-center block">
                  <span>
                    @if (selectedFileBase64()) {
                      {{ 'add.changePhoto' | translate }}
                    } @else {
                      {{ 'add.uploadPhoto' | translate }}
                    }
                  </span>
                  <input id="photo" name="photo" type="file" class="sr-only" (change)="onFileChange($event)" accept="image/*">
                </label>
              </div>
              <div>
                <label for="name" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'device.name' | translate }}</label>
                <input id="name" type="text" formControlName="name" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200">
              </div>
              <div>
                <label for="serialNumber" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'device.serialNumber' | translate }}</label>
                <input id="serialNumber" type="text" formControlName="serialNumber" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200">
              </div>
              <div>
                <label for="manufacturer" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'device.manufacturer' | translate }}</label>
                <input id="manufacturer" type="text" formControlName="manufacturer" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200">
              </div>
              <div>
                <label for="model" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'device.model' | translate }}</label>
                <input id="model" type="text" formControlName="model" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200">
              </div>
              <div>
                <label for="usage" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'device.usage' | translate }}</label>
                <input id="usage" type="text" formControlName="usage" [placeholder]="'add.usagePlaceholder' | translate" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200">
              </div>
              <div>
                <label for="msnCode" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'device.msnCode' | translate }}</label>
                <input id="msnCode" type="text" formControlName="msnCode" [placeholder]="'add.msnPlaceholder' | translate" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200" [class.border-red-500]="deviceForm.controls.msnCode.invalid && deviceForm.controls.msnCode.touched">
                @if (deviceForm.controls.msnCode.invalid && deviceForm.controls.msnCode.touched) {
                  <p class="text-xs text-red-600 dark:text-red-400 mt-1">{{ 'add.msnError' | translate }}</p>
                }
              </div>
            </div>
            <div class="flex justify-end gap-4 p-8 pt-4 bg-slate-50 dark:bg-slate-800/50 rounded-b-xl border-t border-slate-200 dark:border-slate-700">
              <button type="button" (click)="closeAddModal()" [disabled]="isAdding()" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition disabled:opacity-50 disabled:cursor-not-allowed">{{ 'general.cancel' | translate }}</button>
              <button type="submit" [disabled]="deviceForm.invalid || isAdding()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center gap-2">
                @if(isAdding()) {
                  <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                }
                {{ 'general.save' | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    }

    <!-- Calibrate Device Modal -->
    @if (showCalibrateModal() && deviceToCalibrate(); as device) {
      <div class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-80 flex items-center justify-center z-50" (click)="closeCalibrateModal()">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md" (click)="$event.stopPropagation()">
          <div class="p-8 pb-0">
            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">{{ 'calibrate.title' | translate }}</h3>
            <p class="text-slate-600 dark:text-slate-400">{{ 'calibrate.subtitle' | translate }}: <span class="font-semibold text-slate-800 dark:text-slate-200">{{ device.name }} ({{ device.serialNumber }})</span></p>
          </div>
          <form [formGroup]="calibrateForm" (ngSubmit)="submitCalibration()">
            <div class="p-8 space-y-4">
              <div>
                <label for="calibrationDate" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'history.calibrationDate' | translate }}</label>
                <input id="calibrationDate" type="date" formControlName="calibrationDate" (change)="updateNextCalibrationDatePreview()" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200">
              </div>
              <div>
                <label for="calibrationPeriodInYears" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'calibrate.period.label' | translate }}</label>
                <select id="calibrationPeriodInYears" formControlName="calibrationPeriodInYears" (change)="updateNextCalibrationDatePreview()" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-200">
                  <option [value]="1">1 {{ 'general.year' | translate }}</option>
                  <option [value]="2">2 {{ 'general.years' | translate }}</option>
                  <option [value]="3">3 {{ 'general.years' | translate }}</option>
                  <option [value]="4">4 {{ 'general.years' | translate }}</option>
                  <option [value]="0">{{ 'calibrate.period.free' | translate }}</option>
                </select>
              </div>
              <div>
                <label for="nextCalibrationDate" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'history.validUntil' | translate }}</label>
                <input id="nextCalibrationDate" type="text" [value]="nextCalibrationDatePreview()" class="w-full px-3 py-2 border border-slate-200 dark:border-slate-700 rounded-md bg-slate-100 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400" disabled>
              </div>
              <div>
                <label for="label" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{{ 'calibrate.label' | translate }}</label>
                @if (selectedLabelBase64()) {
                  <div class="mb-2 h-32 w-full flex items-center justify-center rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600">
                    <img [src]="selectedLabelBase64()" alt="Kalibračný štítok" class="max-h-full max-w-full object-contain rounded-md">
                  </div>
                }
                <label for="label" class="relative cursor-pointer bg-white dark:bg-slate-700 rounded-md font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500 border border-slate-300 dark:border-slate-600 p-2 text-center block">
                  <span>
                    @if (selectedLabelFileName()) {
                      {{ selectedLabelFileName() }}
                    } @else {
                      {{ 'calibrate.uploadLabel' | translate }}
                    }
                  </span>
                  <input id="label" name="label" type="file" class="sr-only" (change)="onLabelFileChange($event)" accept="image/*">
                </label>
              </div>
            </div>
            <div class="flex justify-end gap-4 p-8 pt-4 bg-slate-50 dark:bg-slate-800/50 rounded-b-xl border-t border-slate-200 dark:border-slate-700">
              <button type="button" (click)="closeCalibrateModal()" [disabled]="isCalibrating()" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition disabled:opacity-50 disabled:cursor-not-allowed">{{ 'general.cancel' | translate }}</button>
              <button type="submit" [disabled]="calibrateForm.invalid || isCalibrating()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition disabled:bg-blue-300 disabled:cursor-not-allowed flex items-center gap-2">
                @if(isCalibrating()) {
                  <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                }
                {{ 'calibrate.saveButton' | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    }

    <!-- History Modal -->
    @if (showHistoryModal() && deviceForHistory(); as device) {
      <div class="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-80 flex items-center justify-center z-50" (click)="closeHistoryModal()">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl" (click)="$event.stopPropagation()">
          <div class="p-8 pb-4">
              <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-2">{{ 'history.title' | translate }}</h3>
              <p class="text-slate-600 dark:text-slate-400">{{ 'history.subtitle' | translate }}: <span class="font-semibold text-slate-800 dark:text-slate-200">{{ device.name }} ({{ device.serialNumber }})</span></p>
          </div>
          <div class="max-h-[60vh] overflow-y-auto px-8">
            @if (sortedHistory().length > 0) {
              <table class="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                <thead class="text-xs text-slate-700 dark:text-slate-300 uppercase bg-slate-50 dark:bg-slate-700">
                  <tr>
                    <th scope="col" class="px-6 py-3">{{ 'history.calibrationDate' | translate }}</th>
                    <th scope="col" class="px-6 py-3">{{ 'history.validUntil' | translate }}</th>
                    <th scope="col" class="px-6 py-3">{{ 'history.period' | translate }}</th>
                    <th scope="col" class="px-6 py-3">{{ 'history.label' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for(cal of sortedHistory(); track $index) {
                    <tr class="bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600/20">
                      <td class="px-6 py-4 font-medium text-slate-900 dark:text-white">{{ cal.calibrationDate | date:'dd.MM.yyyy':'':translationService.currentLocale() }}</td>
                      <td class="px-6 py-4">{{ cal.nextCalibrationDate ? (cal.nextCalibrationDate | date:'dd.MM.yyyy':'':translationService.currentLocale()) : 'N/A' }}</td>
                      <td class="px-6 py-4">
                        @if(cal.calibrationPeriodInYears > 0) {
                          {{ cal.calibrationPeriodInYears }} {{ getPeriodText(cal.calibrationPeriodInYears) }}
                        } @else {
                          {{ 'calibrate.period.free' | translate }}
                        }
                      </td>
                      <td class="px-6 py-4">
                        @if(cal.calibrationLabelUrl) {
                          <img [src]="cal.calibrationLabelUrl" alt="Kalibračný štítok" class="h-12 w-auto rounded cursor-pointer hover:scale-150 transition-transform" (click)="$event.stopPropagation()" title="Kliknite pre zväčšenie">
                        } @else {
                          -
                        }
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            } @else {
              <div class="text-center py-10">
                <p class="text-slate-500 dark:text-slate-400">{{ 'history.noHistory' | translate }}</p>
              </div>
            }
          </div>
          <div class="flex justify-end p-8 pt-4 bg-slate-50 dark:bg-slate-800/50 rounded-b-xl border-t border-slate-200 dark:border-slate-700">
            <button type="button" (click)="closeHistoryModal()" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 rounded-md hover:bg-slate-300 dark:hover:bg-slate-500 transition">{{ 'general.close' | translate }}</button>
          </div>
        </div>
      </div>
    }
  </div>
}
